<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Billing Data</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="service.html?service=gcp">GCP</a>
  <a href="service.html?service=aws">AWS</a>
  <a href="service.html?service=hetzner">Hetzner</a>
  <a href="service.html?service=jira">Jira</a>
  <a href="service.html?service=bitbucket">Bitbucket</a>
  <a href="add-billing.html" class="active">Add Billing</a>
  <a href="instance.html">Instance</a>
</nav>

<div class="app-container">

  <div class="sidebar">
    <button onclick="history.back()">← Back</button>
  </div>

  <div class="main">

    <h1>Add Billing Data</h1>
    <p style="color: #94a3b8; font-size: 16px; margin-bottom: 32px;">
      Enter billing information for your cloud services
    </p>

    <div class="card">
      <label>Entry Type</label>
      <select id="type">
        <option value="daily">Daily Entry</option>
        <option value="monthly">Monthly Entry</option>
      </select>

      <label>Service Name</label>
      <input id="service" placeholder="e.g., gcp, aws, hetzner" required />

      <label>Resource Type</label>
      <input id="resourceType" placeholder="e.g., compute, storage, network" required />

      <label>SKU</label>
      <input id="sku" placeholder="Stock Keeping Unit identifier" required />

      <label>Usage Amount</label>
      <input id="usage" type="number" step="0.01" placeholder="Quantity used" required />

      <label>Price (₹)</label>
      <input id="price" type="number" step="0.01" placeholder="Original price" required />

      <label>Discount Percentage (%)</label>
      <input id="discount" type="number" step="0.01" placeholder="Discount percentage" value="0" />

      <div id="dateContainer">
        <label>Date</label>
        <input id="date" type="date" />
      </div>

      <div id="monthContainer" style="display:none">
        <label>Month (YYYY-MM)</label>
        <input id="month" type="month" />
      </div>

      <button onclick="submitData()" style="width: 100%; margin-top: 16px;">
        Add Billing Data
      </button>
    </div>

  </div>
</div>

<script>
const typeEl = document.getElementById("type");
const dateEl = document.getElementById("date");
const monthEl = document.getElementById("month");
const dateContainer = document.getElementById("dateContainer");
const monthContainer = document.getElementById("monthContainer");

function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  dateEl.value = today;
}

function setDefaultMonth() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  monthEl.value = `${year}-${month}`;
}

setDefaultDate();

typeEl.onchange = () => {
  if (typeEl.value === "daily") {
    dateContainer.style.display = "block";
    monthContainer.style.display = "none";
    setDefaultDate();
  } else {
    dateContainer.style.display = "none";
    monthContainer.style.display = "block";
    setDefaultMonth();
  }
};

async function submitData() {
  const serviceVal = document.getElementById("service").value.trim();
  const resourceTypeVal = document.getElementById("resourceType").value.trim();
  const skuVal = document.getElementById("sku").value.trim();
  const usageVal = document.getElementById("usage").value;
  const priceVal = document.getElementById("price").value;
  const discountVal = document.getElementById("discount").value;

  if (!serviceVal || !resourceTypeVal || !skuVal || !usageVal || !priceVal) {
    alert("Please fill in all required fields");
    return;
  }

  if (typeEl.value === "daily" && !dateEl.value) {
    alert("Please select a date for daily entry");
    return;
  }

  if (typeEl.value === "monthly" && !monthEl.value) {
    alert("Please select a month for monthly entry (format: YYYY-MM)");
    return;
  }

  try {
    const response = await fetch("/api/billing/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: typeEl.value,
        service: serviceVal,
        resourceType: resourceTypeVal,
        sku: skuVal,
        usage: +usageVal,
        price: +priceVal,
        discountPercent: +discountVal || 0,
        date: dateEl.value,
        month: monthEl.value
      })
    });

    if (response.ok) {
      alert("Billing data added successfully!");
      document.getElementById("service").value = "";
      document.getElementById("resourceType").value = "";
      document.getElementById("sku").value = "";
      document.getElementById("usage").value = "";
      document.getElementById("price").value = "";
      document.getElementById("discount").value = "0";

      if (typeEl.value === "daily") {
        setDefaultDate();
      } else {
        setDefaultMonth();
      }
    } else {
      const errorData = await response.json();
      alert("Failed to add billing data: " + (errorData.error || "Unknown error"));
    }
  } catch (error) {
    alert("Error: " + error.message);
  }
}
</script>

</body>
</html>
