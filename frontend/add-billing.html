<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Billing Data</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="service.html?service=gcp">GCP</a>
  <a href="service.html?service=aws">AWS</a>
  <a href="service.html?service=hetzner">Hetzner</a>
  <a href="service.html?service=jira">Jira</a>
  <a href="service.html?service=bitbucket">Bitbucket</a>
  <a href="add-billing.html" class="active">Add Billing</a>
  <a href="instance.html">Instance</a>
  <a href="checklist.html">Checklist</a>
  <a href="kanban.html">Kanban</a>
  <a href="#" onclick="logout()" style="margin-left: auto;">Logout</a>
</nav>

<div class="app-container">

  <div class="sidebar">
    <button onclick="history.back()">← Back</button>
  </div>

  <div class="main">

    <h1>Add Billing Data</h1>
    <p style="color: #94a3b8; font-size: 16px; margin-bottom: 32px;">
      Enter billing information for your cloud services
    </p>

    <div class="card">
      <label>Entry Type</label>
      <select id="type">
        <option value="daily">Daily Entry</option>
        <option value="monthly">Monthly Entry</option>
      </select>

      <label>Service Name</label>
      <input id="service" placeholder="e.g., gcp, aws, hetzner" required />

      <label>Resource Type</label>
      <input id="resourceType" placeholder="e.g., compute, storage, network" required />

      <label>SKU</label>
      <input id="sku" placeholder="Stock Keeping Unit identifier" required />

      <label>Usage Amount</label>
      <input id="usage" type="number" step="0.01" placeholder="Quantity used" required />

      <label>Price (₹)</label>
      <input id="price" type="number" step="0.01" placeholder="Original price" required />

      <label>Discount</label>
      <div id="discountBuilder">
        <div style="margin-bottom: 12px;">
          <label style="font-size: 13px; color: #cbd5e1; margin-bottom: 8px; display: block;">Discount Type</label>
          <select id="discountType" style="margin-bottom: 12px;">
            <option value="percentage">Percentage (%)</option>
            <option value="fixed">Fixed Amount (₹)</option>
            <option value="formula">Custom Formula</option>
          </select>
        </div>

        <div id="percentageInput">
          <label style="font-size: 13px; color: #cbd5e1; margin-bottom: 8px; display: block;">Discount Percentage</label>
          <input id="discount" type="number" step="0.01" placeholder="Enter discount percentage" value="0" />
          <div id="discountSuggestions" style="margin-top: 8px; font-size: 12px; color: #64748b;"></div>
        </div>

        <div id="fixedInput" style="display:none;">
          <label style="font-size: 13px; color: #cbd5e1; margin-bottom: 8px; display: block;">Discount Amount (₹)</label>
          <input id="discountFixed" type="number" step="0.01" placeholder="Enter fixed discount amount" value="0" />
        </div>

        <div id="formulaInput" style="display:none;">
          <label style="font-size: 13px; color: #cbd5e1; margin-bottom: 8px; display: block;">Formula</label>
          <input id="discountFormula" type="text" placeholder="e.g., price * 0.1, usage > 100 ? 15 : 5" />
          <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
            Available variables: <code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">price</code>,
            <code style="background: #1e293b; padding: 2px 6px; border-radius: 3px;">usage</code>
          </div>
          <div id="formulaError" style="color: #ef4444; margin-top: 4px; font-size: 12px;"></div>
        </div>
      </div>

      <div id="dateContainer">
        <label>Date</label>
        <input id="date" type="date" />
      </div>

      <div id="monthContainer" style="display:none">
        <label>Month (YYYY-MM)</label>
        <input id="month" type="month" />
      </div>

      <button onclick="submitData()" style="width: 100%; margin-top: 16px;">
        Add Billing Data
      </button>
    </div>

  </div>
</div>

<script>
const typeEl = document.getElementById("type");
const dateEl = document.getElementById("date");
const monthEl = document.getElementById("month");
const dateContainer = document.getElementById("dateContainer");
const monthContainer = document.getElementById("monthContainer");
const discountTypeEl = document.getElementById("discountType");
const serviceEl = document.getElementById("service");

const DISCOUNT_PRESETS = {
  gcp: [
    { label: "Standard (5%)", value: 5 },
    { label: "Volume (10%)", value: 10 },
    { label: "Enterprise (15%)", value: 15 },
    { label: "Custom formula", formula: "usage > 1000 ? 20 : 10" }
  ],
  aws: [
    { label: "On-Demand", value: 0 },
    { label: "Reserved 1yr (20%)", value: 20 },
    { label: "Reserved 3yr (40%)", value: 40 },
    { label: "Spot (70%)", value: 70 }
  ],
  hetzner: [
    { label: "Standard (5%)", value: 5 },
    { label: "Volume (8%)", value: 8 },
    { label: "Annual (12%)", value: 12 }
  ],
  jira: [
    { label: "Free", value: 0 },
    { label: "Standard (10%)", value: 10 },
    { label: "Premium (15%)", value: 15 }
  ],
  bitbucket: [
    { label: "Free", value: 0 },
    { label: "Standard (10%)", value: 10 },
    { label: "Premium (15%)", value: 15 }
  ]
};

function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  dateEl.value = today;
}

function setDefaultMonth() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  monthEl.value = `${year}-${month}`;
}

function updateDiscountSuggestions() {
  const service = serviceEl.value.trim().toLowerCase();
  const suggestionsEl = document.getElementById("discountSuggestions");
  suggestionsEl.innerHTML = "";

  const presets = DISCOUNT_PRESETS[service];
  if (!presets) return;

  const suggestions = presets.map((p, i) => {
    if (p.formula) {
      return `<button type="button" style="background:none; border:none; color:#3b82f6; cursor:pointer; padding:4px 8px; text-align:left;" onclick="setDiscountFormula('${p.formula.replace(/'/g, "&#39;")}')">${p.label}</button>`;
    }
    return `<button type="button" style="background:none; border:none; color:#3b82f6; cursor:pointer; padding:4px 8px; text-align:left;" onclick="setDiscount(${p.value})">${p.label}</button>`;
  });

  if (suggestions.length > 0) {
    suggestionsEl.innerHTML = `<div style="color:#cbd5e1; font-size:12px; margin-bottom:4px;">Suggestions:</div>` + suggestions.join(" ");
  }
}

function setDiscount(value) {
  document.getElementById("discount").value = value;
  discountTypeEl.value = "percentage";
  updateDiscountTypeUI();
}

function setDiscountFormula(formula) {
  document.getElementById("discountFormula").value = formula;
  discountTypeEl.value = "formula";
  updateDiscountTypeUI();
}

function updateDiscountTypeUI() {
  const type = discountTypeEl.value;
  document.getElementById("percentageInput").style.display = type === "percentage" ? "block" : "none";
  document.getElementById("fixedInput").style.display = type === "fixed" ? "block" : "none";
  document.getElementById("formulaInput").style.display = type === "formula" ? "block" : "none";

  if (type === "percentage") {
    updateDiscountSuggestions();
  }
}

function calculateDiscount(price, usage, formula) {
  try {
    const result = Function('price', 'usage', `return ${formula};`)(price, usage);
    return Math.min(Math.max(result, 0), 100);
  } catch (e) {
    throw new Error("Invalid formula: " + e.message);
  }
}

setDefaultDate();
serviceEl.addEventListener("change", updateDiscountSuggestions);
discountTypeEl.addEventListener("change", updateDiscountTypeUI);

typeEl.onchange = () => {
  if (typeEl.value === "daily") {
    dateContainer.style.display = "block";
    monthContainer.style.display = "none";
    setDefaultDate();
  } else {
    dateContainer.style.display = "none";
    monthContainer.style.display = "block";
    setDefaultMonth();
  }
};

async function submitData() {
  const serviceVal = document.getElementById("service").value.trim();
  const resourceTypeVal = document.getElementById("resourceType").value.trim();
  const skuVal = document.getElementById("sku").value.trim();
  const usageVal = parseFloat(document.getElementById("usage").value);
  const priceVal = parseFloat(document.getElementById("price").value);

  if (!serviceVal || !resourceTypeVal || !skuVal || !usageVal || !priceVal) {
    alert("Please fill in all required fields");
    return;
  }

  if (typeEl.value === "daily" && !dateEl.value) {
    alert("Please select a date for daily entry");
    return;
  }

  if (typeEl.value === "monthly" && !monthEl.value) {
    alert("Please select a month for monthly entry (format: YYYY-MM)");
    return;
  }

  let discountPercent = 0;
  const discountType = discountTypeEl.value;

  try {
    if (discountType === "percentage") {
      discountPercent = parseFloat(document.getElementById("discount").value) || 0;
    } else if (discountType === "fixed") {
      const discountAmount = parseFloat(document.getElementById("discountFixed").value) || 0;
      discountPercent = (discountAmount / priceVal) * 100;
    } else if (discountType === "formula") {
      const formula = document.getElementById("discountFormula").value;
      if (!formula.trim()) {
        alert("Please enter a formula");
        return;
      }
      discountPercent = calculateDiscount(priceVal, usageVal, formula);
    }

    discountPercent = Math.min(Math.max(discountPercent, 0), 100);

    const response = await fetch("/api/billing/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: typeEl.value,
        service: serviceVal,
        resourceType: resourceTypeVal,
        sku: skuVal,
        usage: usageVal,
        price: priceVal,
        discountPercent: discountPercent,
        date: dateEl.value,
        month: monthEl.value
      })
    });

    if (response.ok) {
      alert("Billing data added successfully!");
      document.getElementById("service").value = "";
      document.getElementById("resourceType").value = "";
      document.getElementById("sku").value = "";
      document.getElementById("usage").value = "";
      document.getElementById("price").value = "";
      document.getElementById("discount").value = "0";
      document.getElementById("discountFixed").value = "0";
      document.getElementById("discountFormula").value = "";
      document.getElementById("formulaError").innerHTML = "";
      discountTypeEl.value = "percentage";
      updateDiscountTypeUI();

      if (typeEl.value === "daily") {
        setDefaultDate();
      } else {
        setDefaultMonth();
      }
    } else {
      const errorData = await response.json();
      alert("Failed to add billing data: " + (errorData.error || "Unknown error"));
    }
  } catch (error) {
    alert("Error: " + error.message);
  }
}

document.getElementById("discountFormula").addEventListener("blur", () => {
  const formula = document.getElementById("discountFormula").value;
  const errorEl = document.getElementById("formulaError");
  errorEl.innerHTML = "";

  if (!formula.trim()) return;

  try {
    const priceVal = parseFloat(document.getElementById("price").value) || 10;
    const usageVal = parseFloat(document.getElementById("usage").value) || 100;
    const result = calculateDiscount(priceVal, usageVal, formula);
    errorEl.innerHTML = `<span style="color:#10b981;">Preview: ${result.toFixed(2)}%</span>`;
  } catch (e) {
    errorEl.innerHTML = `<span style="color:#ef4444;">${e.message}</span>`;
  }
});

updateDiscountTypeUI();
</script>

<script src="js/auth-check.js"></script>
</body>
</html>
